# .github/workflows/zmk-build.yml
name: ZMK Build – Lily58 split (left + right)

on:
    push:
        branches: ["**"]
    pull_request:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - board: nice_nano_v2
                      shield: lily58_left
                      conf: debug_left.conf # central + USB logging
                    - board: nice_nano_v2
                      shield: lily58_right
                      conf: debug_right.conf # peripheral – no logging

        steps:
            # ----------------------------------------------------
            # 1️⃣ Checkout repository (including submodules)
            # ----------------------------------------------------
            - name: Checkout repository (with submodules)
              uses: actions/checkout@v4
              with:
                  submodules: true # pulls Zephyr, ZMK, etc.

            # ----------------------------------------------------
            # 2️⃣ Install Zephyr SDK (v0.16.9 works for ZMK v0.3)
            # ----------------------------------------------------
            - name: Install Zephyr SDK
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-arm-none-eabi python3-pip wget
                  wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.9/zephyr-sdk-0.16.9-linux_x86_64.tar.xz
                  sudo tar xf zephyr-sdk-0.16.9-linux_x86_64.tar.xz -C /opt
                  sudo /opt/zephyr-sdk-0.16.9/setup.sh
                  echo "ZEPHYR_SDK_INSTALL_DIR=/opt/zephyr-sdk-0.16.9" >> $GITHUB_ENV

            # ----------------------------------------------------
            # 3️⃣ Initialise West workspace
            # ----------------------------------------------------
            - name: Initialise West workspace
              run: |
                  west init -l .
                  west update

            # ----------------------------------------------------
            # 4️⃣ Build each half
            # ----------------------------------------------------
            - name: Build ${{ matrix.shield }}
              env:
                  BOARD: ${{ matrix.board }}
                  SHIELD: ${{ matrix.shield }}
              run: |
                  BUILD_DIR="${{ runner.temp }}/build_${{ matrix.shield }}"
                  west build -s zmk/app -b "$BOARD" -d "$BUILD_DIR" -- \
                    -DZMK_CONFIG=./config \
                    -DSHIELD="$SHIELD" \
                    -DCONF_FILE=./config/${{ matrix.conf }}

            # ----------------------------------------------------
            # 5️⃣ Upload the UF2 artifact
            # ----------------------------------------------------
            - name: Upload UF2 artifact
              uses: actions/upload-artifact@v4
              with:
                  name: "lily58-${{ matrix.shield }}-nice_nano_v2"
                  path: "${{ runner.temp }}/build_${{ matrix.shield }}/zephyr/*.uf2"
